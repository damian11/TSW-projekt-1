<!doctype html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <%- include("header") %>
    <title>Zawody</title>
    <script src="/jquery/dist/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io.connect('//' + window.location.host, {secure: true});
        
        socket.emit("horseMarkReq", {gender: "MALE"});
        socket.on("horseMarkRes", function(data) {
            console.log(data);
        });

        socket.emit("getActiveCompetitionMasterAndCompetitionReq");
        
        socket.on("getActiveCompetitionMasterAndCompetitionRes", function(data) {
            var title = "";
            
            for (var i in data.competitions) {
                var horseMarksTable = buildHorseMarksInGroupTable(data.competitions[i]._id);
                
                $("#horseMarksInGroups").append( $("<h3>"+data.competitions[i].name+"</h3>") );
                $("#horseMarksInGroups").append(horseMarksTable);
                
                if (data.competitions[i].competitionMaster != null) {
                    title = data.competitions[i].competitionMaster.name;
                }
            }
            if (title == "") {
                $("#title").text("Obecnie nie trwają żadne zawody");   
            } else {
                $("#title").text("Obecnie trwają zawody: " + title);   
            }
        });

        socket.on("horseMarkByCompetitionIdRes", function(data) {
            var horseMarks = $("#horseMarkTable" + data.competitionId);
            horseMarks.empty();
            var horsesAvg = {};
            var horses = {};
            var juries = {};
            var horsesSorted = [];

            evalHorsesAvg(data, horsesAvg, horses, juries, horsesSorted);

            buildHorsesAvgHtml(data, horsesAvg, horsesSorted, horseMarks);

            $(".juryRow").hide();
            $(".horseRow").click(function(e) {
                var juryRows = $(this).parent().children(".juryRow[horse="+$(this).attr("id")+"]");
                juryRows.toggle();
            });
        });
        
        socket.on("getHorseStartNumberByCompetitionRes", function(data) {
            var horseStartNumber = $("#horseStartNumber"+data.horseGroup.horse);
            horseStartNumber.text("Koń #" + data.horseGroup.startNumber);
        });
        
        function buildHorseMarksInGroupTable(competitionId) {
            var table = $("<table>");
            table.append("<thead><tr><td>Koń</td><td>Typ</td><td>Głowa</td><td>Ciało</td><td>Nogi</td><td>Ruch</td><td>Średnia</td></tr></thead>");
            var tbody = $("<tbody>").appendTo(table);
            tbody.attr("id", "horseMarkTable" + competitionId);

            socket.emit("horseMarkByCompetitionIdReq", {
                competitionId: competitionId
            });
            
            return table;
        }
        
        function buildHorsesAvgHtml(data, horsesAvg, horsesSorted, horseMarks) {
            var trj;
            var trh;
            for (var j=0; j<horsesSorted.length; j++) {
                for (var i=0; i<data.horseMarks.length; i++) {
                    //Pobieranie numeru startowego konia
                    socket.emit("getHorseStartNumberByCompetitionReq", {
                        horseId: horsesSorted[j].id,
                        competitionId: data.horseMarks[i].competition._id
                    });
                    
                    //Budowanie tabeli z ocenami
                    if (horsesSorted[j].id == data.horseMarks[i].horse._id) {
                        trh = $("#"+data.horseMarks[i].horse._id+".horseRow");
                        if (!trh.length) {//to zeby koń był tylko raz wyświetlony
                            trh = $("<tr>").attr("id", data.horseMarks[i].horse._id).addClass("horseRow");
                            $("<td>").text(data.horseMarks[i].horse.horseName).attr("id","horseStartNumber"+data.horseMarks[i].horse._id).appendTo(trh);
                            $("<td>").text(horsesAvg[data.horseMarks[i].horse._id].type).appendTo(trh);
                            $("<td>").text(horsesAvg[data.horseMarks[i].horse._id].head).appendTo(trh);
                            $("<td>").text(horsesAvg[data.horseMarks[i].horse._id].body).appendTo(trh);
                            $("<td>").text(horsesAvg[data.horseMarks[i].horse._id].legs).appendTo(trh);
                            $("<td>").text(horsesAvg[data.horseMarks[i].horse._id].movement).appendTo(trh);
                            $("<td>").text(horsesAvg[data.horseMarks[i].horse._id].avg).appendTo(trh);
                            horseMarks.append(trh);
                        }

                        trj = $("<tr>").addClass("juryRow").attr("horse", data.horseMarks[i].horse._id);

                        $("<td>").text(data.horseMarks[i].jury.firstName + " " + data.horseMarks[i].jury.lastName).appendTo(trj);
                        $("<td>").text(data.horseMarks[i].type).appendTo(trj);
                        $("<td>").text(data.horseMarks[i].head).appendTo(trj);
                        $("<td>").text(data.horseMarks[i].body).appendTo(trj);
                        $("<td>").text(data.horseMarks[i].legs).appendTo(trj);
                        $("<td>").text(data.horseMarks[i].movement).appendTo(trj);

                        horseMarks.append(trj);
                    }
                }
            }
        }
        
        function evalHorsesAvg(data, horsesAvg, horses, juries, horsesSorted) {
            for (var i=0; i<data.horseMarks.length; i++) {
                horses[data.horseMarks[i].jury._id] = [];
            }
                                                       // robimy pętle po odpowiedzi z serwera
            //Obliczenie liczby sędziów
            for (var i=0; i<data.horseMarks.length; i++) {
                juries[data.horseMarks[i].jury._id] = 1;
            }
            var juriesNo = Object.keys(juries).length;

            //unikalna mapa koni z inicjalnymi wartościami średnich ocen
            for (var i=0; i<data.horseMarks.length; i++) {
                horsesAvg[data.horseMarks[i].horse._id] = {
                    id: data.horseMarks[i].horse._id,
                    type: 0,
                    head: 0,
                    body: 0,
                    legs: 0,
                    movement: 0,
                    avg: 0
                };
            }

            //obliczenie wartości średnich ocen koni - sumowanie
            for (var i=0; i<data.horseMarks.length; i++) {
                horsesAvg[data.horseMarks[i].horse._id].type += data.horseMarks[i].type;
                horsesAvg[data.horseMarks[i].horse._id].head += data.horseMarks[i].head;
                horsesAvg[data.horseMarks[i].horse._id].body += data.horseMarks[i].body;
                horsesAvg[data.horseMarks[i].horse._id].legs += data.horseMarks[i].legs;
                horsesAvg[data.horseMarks[i].horse._id].movement += data.horseMarks[i].movement;
            }
            for(var key in horsesAvg) {
                horsesAvg[key].type /= juriesNo;
                horsesAvg[key].head /= juriesNo;
                horsesAvg[key].body /= juriesNo;
                horsesAvg[key].legs /= juriesNo;
                horsesAvg[key].movement /= juriesNo;
                horsesAvg[key].avg = (horsesAvg[key].type + horsesAvg[key].head + horsesAvg[key].body + horsesAvg[key].legs + horsesAvg[key].movement)/5;
            }

            for(var key in horsesAvg) {
                horsesSorted.push(horsesAvg[key]);
            }
            horsesSorted.sort(function(a, b) {
                return b.avg - a.avg;
            });
        }
        
    </script>
</head>

<body>
    <h1 id="title"></h1>
    <div id="horseMarksInGroups"></div>

</body>

</html>
