<!doctype html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Zawody</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />    
    <script src="/jquery/dist/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <script>
    $(function() {
        var socket = io.connect('//' + window.location.host, {secure: true});
        
        socket.on("competitionActivateRes", function(data) {
            window.location = "/newCompetitionStep2/" + data.competitionId;
        });

        socket.emit("availableHorsesReq", {
            gender: "<%= competition.gender %>",
            competitionId: "<%= competition._id %>"
        });
        socket.on("availableHorsesRes", function(data) {
            var horsesList = $("#horses table tbody");
            horsesList.empty();

            for (var i=0; i<data.length; i++) {
                var row = $("<tr />");
                row.append("<td>" + data[i].horseName +"</td>");
                row.append("<td>" + data[i].gender +"</td>");
                row.append("<td>" + data[i].owner +"</td>");
                row.append("<td>" + data[i].dateOfBirth +"</td>");

                var addButton = $("<td>");
                addButton.attr("horseId", data[i]._id)
                $("<i class='material-icons'>add_circle_outline</i>").appendTo(addButton);
                addButton.click(function(e) {
                    socket.emit("horseAddToCompetitionReq", {
                        competitionId: '<%= competition._id %>',
                        horseId: $(this).attr("horseId")
                    });
                });
               
                    <%if(competition.isActive == false){%>
                    
                    row.append(addButton);
                    <% }%>
                horsesList.append(row);
            }
        });

        socket.on("horseAddToCompetitionRes", function(data) {
            window.location = "/newCompetitionStep2/" + data.competitionId;
        });   

        socket.emit("horsesByCompetitionIDReq", {
            competitionId: "<%= competition._id %>"
        });
        socket.on("horsesByCompetitionIDRes", function(data) {
            var horsesInCompetition = $("#horsesInCompetition table tbody");
            horsesInCompetition.empty();

            for (var i=0; i<data.length; i++) {
                var row = $("<tr />");
                row.append("<td>" + data[i].horse.horseName +"</td>");
                row.append("<td>" + ( data[i].horse.gender == "MALE" ? "Ogier" : "Klacz" ) +"</td>");
                row.append("<td>" + data[i].horse.owner +"</td>");
                row.append("<td>" + data[i].horse.dateOfBirth +"</td>");
                row.append("<td>" + ( data[i].isActive == true ? "TAK" : "NIE" ) +"</td>");

                <% if (competition.isActive) { %>
                    var activateButton = $("<td>");
                    activateButton.attr("horseId", data[i].horse._id);
                    if (data[i].isActive == true) {
                        $("<i class='material-icons'>highlight_off</i>").appendTo(activateButton);
                    } else {
                        $("<i class='material-icons'>done</i>").appendTo(activateButton);
                    }
                    activateButton.click(function(e) {
                        socket.emit("horseActivateInCompetitionReq", {
                            competitionId: '<%= competition._id %>',
                            horseId: $(this).attr("horseId")
                        });
                    });
                    row.append(activateButton);
                    horsesInCompetition.append(row);
                <% } else { %>
                    var deleteButton = $("<td>");
                    deleteButton.attr("horseId", data[i].horse._id);
                    $("<i class='material-icons'>remove_circle_outline</i>").appendTo(deleteButton);
                    deleteButton.click(function(e) {
                        socket.emit("horseDeleteFromCompetitionReq", {
                            competitionId: '<%= competition._id %>',
                            horseId: $(this).attr("horseId")
                        });
                    });
                    row.append(deleteButton);
                    horsesInCompetition.append(row);
                <% } %>
            }
        });
        socket.on("horseActivateInCompetitionRes", function(data) {
            window.location = "/newCompetitionStep2/" + data.competitionId;
        });
        socket.on("horseDeleteFromCompetitionRes", function(data) {
            window.location = "/newCompetitionStep2/" + data.competitionId;
        });

        socket.emit("availableJuryReq", {
            competitionId: "<%= competition._id %>"
        });

        socket.on("availableJuryRes", function(data) {
            var juryList = $("#juries table tbody");
            juryList.empty();

            for (var i=0; i<data.length; i++) {
                var row = $("<tr />");
                row.append("<td>" + data[i].username +"</td>");
                row.append("<td>" + data[i].password +"</td>");
                row.append("<td>" + data[i].firstName +"</td>");
                row.append("<td>" + data[i].lastName +"</td>");

                var addButton = $("<td>");
                addButton.attr("juryId", data[i]._id)
                $("<i class='material-icons'>add_circle_outline</i>").appendTo(addButton);
                addButton.click(function(e) {
                    socket.emit("juryAddToCompetitionReq", {
                        competitionId: '<%= competition._id %>',
                        juryId: $(this).attr("juryId")
                    });
                });
                
                <% if (competition.isActive == false)  { %>
                row.append(addButton);
                <% } %>
                juryList.append(row);
            }
        });

        socket.on("juryAddToCompetitionRes", function(data) {
            window.location = "/newCompetitionStep2/" + data.competitionId;
        });

        socket.on("juryDeleteFromCompetitionRes", function(data) {
            window.location = "/newCompetitionStep2/" + data.competitionId;
        }); 
        socket.emit("juriesByCompetitionIDReq", {
            competitionId: "<%= competition._id %>"
        });
        socket.on("juriesByCompetitionIDRes", function(data) {
            var juriesInCompetition = $("#juriesInCompetition table tbody");
            juriesInCompetition.empty();

            for (var i=0; i<data.length; i++) {
                var row = $("<tr />");
                row.append("<td>" + data[i].username +"</td>");
                row.append("<td>" + data[i].password +"</td>");
                row.append("<td>" + data[i].firstName+"</td>");
                row.append("<td>" + data[i].lastName +"</td>");

                var deleteButton = $("<td>");
                deleteButton.attr("juryId", data[i]._id)
                $("<i class='material-icons'>remove_circle_outline</i>").appendTo(deleteButton);
                deleteButton.click(function(e) {
                    socket.emit("juryDeleteFromCompetitionReq", {
                        competitionId: '<%= competition._id %>',
                        juryId: $(this).attr("juryId")
                    });
                });
                <%if(competition.isActive == false){ %>
                             row.append(deleteButton);
                
                   <%  } %>
                
        
                juriesInCompetition.append(row);
            }
        });
        socket.on("juriesDeleteFromCompetitionRes", function(data) {
            window.location = "/newCompetitionStep2/" + data.competitionId;
        });
        
        $("#competitionStart").click(function(e) {
            socket.emit("competitionStartReq", {
                competitionId: "<%= competition._id %>"
            });
        });
        socket.on("competitionStartRes", function(data){
            $("#competitionStatus").text("Aktywne");
            window.location = "/newCompetitionStep2/" + data.competitionId;
        });
            
        $("#competitionStop").click(function(e) {
            socket.emit("competitionStopReq", {
                competitionId: "<%= competition._id %>"
                
            });
        });
        socket.on("competitionStopRes", function(data){
            $("#competitionStatus").text("Nieaktywne");
            window.location = "/newCompetitionStep2/" + data.competitionId;
        });
    });
        
        
    </script>
    
    <input type="hidden" id="competitionId" value="<%= competition._id %>" />
    
    <a href="/administrator">Strona administratora</a>

    <h1>Widok zawodów <%= competition.name %></h1>
    
    <div id="competitionStart">Rozpocznij</div>
    <div id="competitionStop">Zakończ</div>
    <div id="competitionStatus">Status: <%= competition.isActive ? "Aktywne" : "Nieaktywne" %></div>
    <h2>Konie w zawodach</h2>
    <div id="horsesInCompetition">
        <table>
            <thead>
                <tr>
                    <td>Nazwa</td>
                    <td>Płeć</td>
                    <td>Właściciel</td>
                    <td>Data urodzenia</td>
                    <td>Czy aktywny</td>
                    <td>Operacje</td>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <h2>Dostępne konie</h2>
    <div id="horses">
        <table>
            <thead>
                <tr>
                    <td>Nazwa</td>
                    <td>Płeć</td>
                    <td>Właściciel</td>
                    <td>Data urodzenia</td>
                    <td>Czy aktywny</td>
                    <td>Operacje</td>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <h2>sędziowie w zawodach</h2>
    <div id="juriesInCompetition">
        <table>
            <thead>
                <tr>
                    <td>Nazwa użytkownika</td>
                    <td>Hasło</td>
                    <td>Imię</td>
                    <td>Nazwisko</td>
                    <td>Operacje</td>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <h2>Dostępni sędziowie</h2>
    <div id="juries">
        <table>
            <thead>
                <tr>
                    <td>Nazwa użytkownika</td>
                    <td>Hasło</td>
                    <td>Imię</td>
                    <td>Nazwisko</td>
                    <td>Operacje</td>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

   
    
</body>
</html>
